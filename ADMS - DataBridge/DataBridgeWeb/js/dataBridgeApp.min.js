var adms={databridge:{getConfig:function(e){$.ajax({dataType:"json",url:"/Home/GetConfig",success:function(n){e(n)},error:function(e,n,t){console.log(n)}})},getPlugins:function(e){$.ajax({dataType:"json",url:"/Home/GetPlugins",success:function(n){e(n)},error:function(e,n,t){console.log(n)}})},getData:function(e,n){$.ajax({dataType:"json",data:{uri:e},url:"/Home/GetData",success:function(e){n(e)},error:function(e,n,t){console.log(n)}})},getScenarioRun:function(e,n){$.ajax({dataType:"json",data:{id:e},url:"/Home/GetScenarioRun",success:function(e){n(e)},error:function(e,n,t){console.log(n)}})},getScenarioRuns:function(e,n){$.ajax({dataType:"json",data:{id:e},url:"/Home/GetScenarioRuns",success:function(e){n(e)},error:function(e,n,t){console.log(n)}})},getScenarioRunResults:function(e,n){$.ajax({dataType:"json",data:{id:e},url:"/Home/GetScenarioRunResults",success:function(e){n(e)},error:function(e,n,t){console.log(n)}})},startNewScenarioRun:function(e,n,t,r){$.ajax({dataType:"json",type:"POST",data:{id:e,description:n,parameters:t},url:"/Home/StartScenarioRun",success:function(e){r(e)},error:function(e,n,t){console.log(n)}})}}},getTime=function(e){var n=parseInt(e.split("(")[1].split(")")[0]);return n};!function(){"use strict";angular.module("adms_dataBridge",["highcharts-ng","adms_dataBridge.controllers","adms_dataBridge.metisMenu","adms_dataBridge.service"])}(),$(function(){$("#side-menu").metisMenu(),$("#startDatePicker").datepicker({autoclose:!0}),$("#endDatePicker").datepicker({autoclose:!0})}),$(function(){$(window).bind("load resize",function(){topOffset=50,width=this.window.innerWidth>0?this.window.innerWidth:this.screen.width,width<768?($("div.navbar-collapse").addClass("collapse"),topOffset=100):$("div.navbar-collapse").removeClass("collapse"),height=(this.window.innerHeight>0?this.window.innerHeight:this.screen.height)-1,height-=topOffset,height<1&&(height=1),height>topOffset&&$("#page-wrapper").css("min-height",height+"px")});var e=window.location,n=$("ul.nav a").filter(function(){return this.href==e||0==e.href.indexOf(this.href)}).addClass("active").parent().parent().addClass("in").parent();n.is("li")&&n.addClass("active")});var widgets={colours:["#AA4643","#4572A7","#89A54E","#80699B","#3D96AE","#DB843D","#92A8CD","#A47D7C","#B5CA92"],drawTimeRegions:function(e,n){var t=e.xAxis[0].min,r=e.xAxis[0].max,o=r-t;o>=2592e6?n=1:2592e6>o&&(n=0);var a="rgba(220,200,180,0.1)";if(null!=e.xAxis[0].plotLinesAndBands)for(var i in e.xAxis[0].plotLinesAndBands){var s=e.xAxis[0].plotLinesAndBands[i];null!=s.id&&0==s.id.indexOf("we")&&e.xAxis[0].removePlotBand(s.id)}var l=new Date(t);if(2==n){var c=new Date(l.getFullYear(),l.getMonth(),1),u=new Date(l.getFullYear(),l.getMonth()+1,1);do e.xAxis[0].addPlotBand({from:c.getTime(),to:u.getTime(),color:a,id:"we",zIndex:-2}),c.setMonth(c.getMonth()+2),u.setMonth(u.getMonth()+2);while(u.getTime()<r)}if(1==n){l.setUTCDate(l.getUTCDate()-(l.getUTCDay()+1)%7),l.setUTCSeconds(0),l.setUTCMinutes(0),l.setUTCHours(0);var d=l.getTime();do e.xAxis[0].addPlotBand({from:d,to:d+1728e5,color:a,id:"we",zIndex:-2}),d+=6048e5;while(r>d)}if(0==n){l.setUTCSeconds(0),l.setUTCMinutes(0),l.setUTCHours(0);var d=l.getTime();do e.xAxis[0].addPlotBand({from:d,to:d+216e5,color:a,id:"we",zIndex:-2}),e.xAxis[0].addPlotBand({from:d+648e5,to:d+864e5,color:a,id:"we",zIndex:-2}),d+=864e5;while(r>d)}},generateData:function(e){for(var n=[],t=[],r=0;r<e.values.length;r++)value=e.values[r],t.push([getTime(value.timeStamp),value.value]);return n.push({name:"Data",color:widgets.colours[0],data:t}),{series:n}},generateScenarioData:function(e){for(var n=[],t=0;t<e.results.length;t++){for(var r=[],o=0;o<e.results[t].values.length;o++)value=e.results[t].values[o],r.push([getTime(value.time),value.value]);n.push({name:e.results[t].name,color:widgets.colours[t],data:r})}return{series:n}},bridgees:{lineWidget:function(e){var n=widgets.generateData(e),t=n.series,r="{value: %H:%M}",o="line",a={options:{colors:widgets.colours,chart:{backgroundColor:"transparent",type:o,marginTop:34,marginLeft:40,height:300,events:{load:function(e){},redraw:function(e){widgets.drawTimeRegions(e.target,0)}}},plotOptions:{line:{lineWidth:2,marker:{enabled:!1},opacity:1},series:{dataLabels:{formatter:function(){return"<b>"+this.point.name+"</b>: "+this.percentage.toFixed(2)+" %"}}}},legend:{enabled:!0,align:"center",verticalAlign:"bottom"}},title:{text:""},xAxis:{type:"datetime",tickPixelInterval:150,labels:{format:r}},yAxis:{title:{text:"W h",textAlign:"right",rotation:0,x:30,y:-165}},tooltip:{enabled:!0},credits:{enabled:!1},series:t};return a}},scenarios:{lineWidget:function(e){var n=widgets.generateScenarioData(e),t=n.series,r="line",o={options:{colors:widgets.colours,chart:{backgroundColor:"transparent",type:r,marginTop:34,marginLeft:40,height:300,events:{load:function(e){},redraw:function(e){widgets.drawTimeRegions(e.target,0)}}},plotOptions:{line:{lineWidth:2,marker:{enabled:!1},opacity:1},series:{dataLabels:{formatter:function(){return"<b>"+this.point.name+"</b>: "+this.percentage.toFixed(2)+" %"}}}},legend:{enabled:!0,align:"center",verticalAlign:"bottom"}},title:{text:""},xAxis:{type:"datetime",tickPixelInterval:150},yAxis:{title:{text:"W h",textAlign:"right",rotation:0,x:30,y:-165}},tooltip:{enabled:!0},credits:{enabled:!1},series:t};return o}}};angular.module("adms_dataBridge.service",[]).service("bridgeService",function(){var e={};return e.getBridge=function(e){return e},e}),angular.module("adms_dataBridge.metisMenu",[]).directive("metis",function(e){return function(n,t,r){1==n.$last&&e(function(){$("#side-menu").metisMenu()},250)}}),angular.module("adms_dataBridge.intergerOnly",[]).directive("numberOnly",function(){return console.log("inside directive"),{require:"ngModel",restrict:"A",link:function(e){e.$watch("inputValue",function(n,t){var r=String(n).split("");0!==r.length&&(1!==r.length||"-"!=r[0]&&"."!==r[0])&&(2!==r.length||"-."!==n)&&isNaN(n)&&(e.inputValue=t)})}}});var myApp=angular.module("adms_dataBridge.controllers",["ngRoute","ui.bootstrap","highcharts-ng","ngAnimate","ui.mask"]);myApp.config(function(e){e.when("/",{controller:"",templateUrl:"templates/blank.html"}).when("/dashboard",{controller:"DashboardController",templateUrl:"templates/dashboard.html"}).when("/inPlugin/:inPluginId",{controller:"InPluginController",templateUrl:"templates/plugin.html"}).when("/outPlugin/:outPluginId",{controller:"OutPluginController",templateUrl:"templates/plugin.html"}).when("/bridge/:id",{controller:"BridgeController",templateUrl:"templates/bridge.html"}).when("/realTime",{controller:"RealTimeModellingController",templateUrl:"templates/realTime.html"}).when("/scenario/:scenarioID",{controller:"ScenarioModellingController",templateUrl:"templates/scenario.html"}).when("/scenario/:scenarioID/scenarioDetails",{controller:"ScenarioModellingController",templateUrl:"templates/scenarioDetails.html"})}),myApp.controller("DashboardController",["$scope",function(e){e.dashboard={},e.plugins={},adms.databridge.getPlugins(function(n){console.log("Getting plugins here......"),console.log(n),e.plugins=n,e.$apply()})}]),myApp.controller("HomeController",["$scope","$routeParams",function(e,n){e.config={},e.isSecenarioSubmitted=!1,e.breadcrumbs="templates/breadcrumb.html",e.trimUri=function(e){var n=e.substring(e.indexOf("/",7));return n.substring(n.indexOf("/")+1)},e.encodeUri=function(e){return e},e.splitCommands=function(e){return e.split(";")},e.splitCommand=function(e){var n=e.split("=");return n[0].indexOf(" ")>=0?(console.log("space found in"+n[0]),{key:"Command",value:e}):1==n.length?{key:"Command",value:n[0]}:{key:n[0],value:n[1]}},e.getMode=function(e){return 1==e?"Schedule":"Subscription"},adms.databridge.getConfig(function(n){e.config=n,console.log("Config Data:"),console.log(n);for(var t=0;t<e.config.dataBridge.Bridgees.length;t++){var r=e.config.dataBridge.Bridgees[t];r.index=t}e.$apply()})}]),myApp.controller("InPluginController",["$routeParams","$scope",function(e,n){n.inPluginId=e.inPluginId,console.log("$routeParams.inPluginId: "+e.inPluginId),n.plugin=n.config.dataBridge.InPlugins[n.inPluginId],n.uri=n.plugin.Uri,console.log(n.plugin)}]),myApp.controller("OutPluginController",["$routeParams","$scope",function(e,n){n.outPluginId=e.outPluginId,console.log("OutPluginController "+n.outPluginId),n.plugin=n.config.dataBridge.OutPlugins[n.outPluginId],console.log(n.plugin)}]),myApp.controller("BridgeController",["$routeParams","$scope","highchartsNG",function(e,n,t){n.id=e.id,console.log("BridgeController "+n.id),n.bridge=n.config.dataBridge.Bridgees[n.id];var r=function(){adms.databridge.getData(n.bridge.Uri,function(e){console.log(e),e.result&&(n.data=e,n.loadData(),n.$apply())})};n.highchartsNG={options:{chart:{backgroundColor:"transparent",height:300},title:{text:""}}},n.loadData=function(){$.extend(n.highchartsNG,widgets.bridgees.lineWidget(n.data))},n.$watch("$scope.bridge.Uri",function(){n.bridge.Uri&&r()})}]),myApp.controller("RealTimeModellingController",["$routeParams","$scope",function(e,n){}]),myApp.controller("ScenarioModellingController",["$routeParams","$scope","$location","highchartsNG","$timeout",function(e,n,t,r,o){n.newScenarioArray={parameters:[]},n.scenarioID=e.scenarioID,console.log("scenarioID: "+n.scenarioID),n.scenario=n.config.scenarios[n.scenarioID],console.log("--------------Current Scenario--------------"),console.log(n.scenario),n.fetchScenarioRuns=function(){adms.databridge.getScenarioRuns(n.scenarioID,function(e){console.log("-------------- Data for already running Scenario --------------"),console.log(e),e.result&&(n.scenarioRunsData=e,n.$apply())})},adms.databridge.getScenarioRun(n.scenarioID,function(e){e.result&&(n.scenarioDetails=e,n.$apply())}),n.fetchScenarioHighchart=function(){adms.databridge.getScenarioRunResults(n.scenarioID,function(e){console.log("--------------Scenario Run Results for Line Chart--------------"),console.log(e),e.result&&(n.scenarioHighchartData=e,n.loadData(),n.$apply())})},n.scenarioHighchart={options:{chart:{backgroundColor:"transparent",height:300},title:{text:""}}},n.loadData=function(){n.test=n.getIndicesOfDuplicateGroupType(),console.log("***********************"),console.log(n.test),console.log("Load Data function"),$.extend(n.scenarioHighchart,widgets.scenarios.lineWidget(n.scenarioHighchartData))},n.getIndicesOfDuplicateGroupType=function(){var e=[],t=[];for(i=0;i<n.scenarioHighchartData.results.length;i++)"Storage"==n.scenarioHighchartData.results[i].group&&e.push(i),"Turbine"==n.scenarioHighchartData.results[i].group&&t.push(i);return[e,t]},n.findScenarioGroupTypes=function(e){n.groupTypeCount=[],n.arr={};var t;for(t=0;t<e.results.length;t++)n.arr[e.results[t].group]=0;for(t in n.arr)n.groupTypeCount.push(t);return console.log(n.groupTypeCount),n.groupTypeCount},n.submitScenarioData=function(e){console.log("New scenario input data"),n.newScenarioArray.scenarioRunId=n.scenarioRunsData.runs.length;for(var t=0;t<n.scenario.config.parameters.length;t++)n.newScenarioArray.parameters[t].name=n.scenario.config.parameters[t].name,n.newScenarioArray.parameters[t].type=n.scenario.config.parameters[t].type;console.log(n.newScenarioArray);var r=angular.copy(n.newScenarioArray);n.scenarioRunsData.runs.push(r),console.log("Check for pushed new scenario data"),console.log(n.scenarioRunsData),n.runNewScenario(n.newScenarioArray),n.resetNewScenarioInputs()},n.resetNewScenarioInputs=function(){console.log("Reset Scenario Inputs"),n.newScenarioArray.scenarioRunId="",n.newScenarioArray.description="",n.newScenarioArray.timeStamp="";for(var e=0;e<n.newScenarioArray.parameters.length;e++)n.newScenarioArray.parameters[e].value="";console.log(n.newScenarioArray)},n.formatDate=function(e){var n=e.substring(e.indexOf("(")+1,e.indexOf(")"));return n},n.editScenario=function(e,t){n.newScenarioArray={scenarioRunId:"",description:"",parameters:[],timeStamp:"",runTime:""},console.log(t),n.newScenarioArray=t,n.index=e;var r=n.scenarioRunsData.runs[n.index].parameters.length;if(console.log("Assigning alreday running scenario to new Scenario panel inputs for edit"),console.log(typeof n.newScenarioArray),n.newScenarioArray.description=n.scenarioRunsData.runs[n.index].description,0==n.newScenarioArray.parameters.length)for(i=0;i<r;i++)n.newScenarioArray.parameters[i]={},n.newScenarioArray.parameters[i].value=n.scenarioRunsData.runs[n.index].parameters[i].value;else for(i=0;i<r;i++)n.newScenarioArray.parameters[i].value=n.scenarioRunsData.runs[n.index].parameters[i].value;console.log(n.newScenarioArray)},n.runNewScenario=function(e){console.log("Sending new scenario to Server"),n.newScenario=e,adms.databridge.startNewScenarioRun(n.newScenario.scenarioRunId,n.newScenario.description,n.newScenario.parameters,function(e){})},n.$watch("location",function(){t&&(n.fetchScenarioRuns(),n.fetchScenarioHighchart())})}]);